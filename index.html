<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">唐朝街市动画</title>
    <style>
        body {
         margin: 0;
                   padding: 0;
                   background-color: #f0e6d2;
                   display: flex;
                   justify-content: center;
                   align-items: center;
                   min-height: 100vh;
        }
        .scene-container {
            position: relative;
            width: 640px;
            height: 1030px;
            overflow: hidden;
        }
        .background {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .animate-element {
            position: absolute;
            transition: all 1.5s ease-out; 
        }
        /* 人物（仅唐朝显示） */
        #img1 {
            bottom: 0%;
            right: -350px; 
            width: 100%; 
            display: none;
        }
        /* 朝代图标 */
        #img2 {
            top: -200px; 
            left: 70%;
            width: 70px;
            cursor: pointer;
            z-index: 4;
        }
        /* 光圈样式 - 新增 */
        #lightRing {
            position: absolute;
            width: 80px; /* 比图标稍大，可根据需求调整 */
            height: 80px;
            opacity: 0;
            transition: opacity 0.5s ease-out;
            z-index: 5; /* 比图标高，比弹窗低 */
            pointer-events: none; /* 不影响图标点击 */
        }
        /* 光圈放大缩小动画 - 新增 */
        @keyframes scalePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .scale-pulse {
            animation: scalePulse 1.5s infinite ease-in-out;
        }
        /* 弹窗基础样式 */
        .center-image {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 1s ease-out;
            max-width: 100%;
            max-height: 100%;
            z-index: 6; /* 调整层级，避免被光圈遮挡 */
            pointer-events: none;
        }
        .center-text {
            position: absolute;
            top: 46%;
            left: 52.5%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 1s ease-out;
            max-width: 100%;
            max-height: 100%;
            z-index: 7; /* 调整层级 */
            pointer-events: none;
            display: none;
        }
        /* 民国特有元素 */
        .fog {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease-out;
            z-index: 10;
            pointer-events: none;
            display: none;
        }
        .hualing {
            position: absolute;
            top: 38%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 100%;
            max-height: 100%;
            opacity: 0;
            transition: opacity 1s ease-out;
            z-index: 11;
            pointer-events: none;
            display: none;
        }
        .text-box {
            position: absolute;
            top: 73%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            max-height: 80%;
            opacity: 0;
            transition: opacity 1s ease-out 0.5s;
            z-index: 12;
            pointer-events: none;
            display: none;
        }
        .text-content {
            position: absolute;
            top: 73%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 80%;
            max-height: 70%;
            opacity: 0;
            transition: opacity 1s ease-out 1s;
            z-index: 13;
            pointer-events: none;
            display: none;
        }
        .start-btn {
            position: absolute;
            bottom: 45px;
            left: 77%;
            transform: translate(-50%, 0);
            max-width: 150px;
            opacity: 0;
            transition: opacity 1s ease-out 1.5s;
            z-index: 14;
            cursor: pointer;
            display: none;
        }
        /* 脉冲动画 */
        @keyframes pulse {
            0% { transform: translate(-50%, 0) scale(1); }
            50% { transform: translate(-50%, 0) scale(1.1); }
            100% { transform: translate(-50%, 0) scale(1); }
        }
        .pulse {
            animation: pulse 1.5s infinite ease-in-out;
        }
        /* 滚动提示 */
        .scroll-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #666;
            font-size: 14px;
            z-index: 999;
            opacity: 0.7;
            display: none;
        }

        /* 音乐图标样式 - 固定在容器右上角 */
        #music-icon {
            position: absolute;
            top: 25px;   
            right: 25px;  
            width: 50px;   
            height: auto; 
            z-index: 9999;     
            cursor: pointer;  
            pointer-events: auto; 
            transition: transform 0.2s ease; 
        }

        /* 音乐图标悬停效果 */
        #music-icon:hover {
            transform: scale(1.05); /* 轻微放大，提升交互体验 */
        }
    </style>
</head>
<body>
    <div class="scene-container">
        <!-- 音乐图标 - 初始状态同步上一页 -->
        <img src="music1.png" alt="音乐图标" id="music-icon">
        
        <!-- 基础元素 -->
        <img src="" class="background" id="backgroundImg" alt="背景图">
        <img src="" class="animate-element" id="img1" alt="人物图片">
        <img src="" class="animate-element" id="img2" alt="朝代图标">
        <!-- 新增光圈元素 -->
        <img src="rh4/光圈.png" id="lightRing" alt="光圈">
        <img src="" class="center-image" id="img3" alt="弹窗图片1">
        <img src="" class="center-image" id="img4_centerImage" alt="弹窗图片2（唐朝）">
        <img src="" class="center-text" id="img4_centerText" alt="弹窗图片2（清朝/民国）">
        
        <!-- 民国特有元素 -->
        <img src="" class="fog" id="fog" alt="灰雾">
        <img src="" class="hualing" id="hualing" alt="花灵">
        <img src="" class="text-box" id="textBox" alt="文本框">
        <img src="" class="text-content" id="textContent" alt="文本">
        <img src="" class="start-btn" id="startBtn" alt="开始">
    </div>
    <div class="scroll-hint">上滑查看更多</div>

    <script>
        // ================= 核心配置 =================
        // 1. 页面流程：tang→qing→minguo
        const pageFlow = {
            tang: { next: 'qing', title: '唐朝街市动画' },
            qing: { next: 'minguo', title: '清朝动画' },
            minguo: { next: '', title: '民国动画' }
        };

        // 2. 图片路径配置（根据实际路径调整，确保正确）
        const imageConfig = {
            tang: {
                background: 'rh4/ad664abc7422b306f6c6dd23a5bbc421.png',
                img1: 'rh4/6a0f34785eb075c66254af1685c34b68.png', // 人物
                img2: 'rh4/3e3d00ea1d9eb3ce494841a7b1357d38.png', // 图标
                img3: 'rh4/61a678f208fbaaa311b01416f7756381.png', // 弹窗1
                img4: 'rh4/3e3c8c2fe6775a7ba629556e118d2c69.png', // 弹窗2
                img2Top: '140px',
                img2Left: '70%'
            },
            qing: {
                background: 'rh4/08de0e9b182e82becdc3ced293890c13.jpg',
                img2: 'rh4/4d5334f32e9674e66a3d20886b5e9294.png', // 图标
                img3: 'rh4/61a678f208fbaaa311b01416f7756381.png', // 弹窗1
                img4: 'rh4/bb2badae01f15cf356a5e3a887baf8ab.png', // 弹窗2
                img2Top: '100px',
                img2Left: '75%',
                centerTextTop: '46%',
                centerTextLeft: '52.5%'
            },
            minguo: {
                background: 'rh4/fa5aa5344466c37f8d1b49f011b9c46e.png',
                img2: 'rh4/c89f4a11379762c4f9e16bcb2cf0ac3e.png', // 图标
                img3: 'rh4/61a678f208fbaaa311b01416f7756381.png', // 弹窗1
                img4: 'rh4/e1486758c0401bb1b8f979cd03dd0a17.png', // 弹窗2
                img2Top: '100px',
                img2Left: '75%',
                centerTextTop: '49%',
                centerTextLeft: '51%',
                // 民国特有元素
                fog: 'rh4/c3f5e9427e0ca331318c8c72bfc49402.png',
                hualing: 'rh4/b51a45769df545773eee5b52f3395840.png',
                textBox: 'rh4/1049912e592100ff409228f85c496fc0.png',
                textContent: 'rh4/5ab933c170b42c8bc0c1973f2d8cf6ae.png',
                startBtn: 'rh4/e2a1c7c047f65cfda0df28a8b198a000.png'
            }
        };

        // ================= 全局变量 =================
        let currentPage = getCurrentPage(); // 从URL参数获取当前页面
        const currentConfig = imageConfig[currentPage];
        const currentFlow = pageFlow[currentPage];
        let isTransitioning = false;
        // 新增：标记是否已点击朝代图标（初始为未点击，禁止滚动跳转）
        let hasClickedIcon = false;
        // 民国特有变量
        let scrollDetectionEnabled = false;
        let hasTriggeredNextScene = false;
        // 新增：跳转目标路径（startBtn点击后跳转的地址）
        const startBtnJumpUrl = 'file:///D:/绒花1/flower-5/index5.html';

        // ================= 音乐功能全局变量 =================
        let audio = new Audio('music.mp3'); // 保持和上一页相同的音频文件
        audio.loop = true;
        audio.volume = 0.8;
        let audioState = JSON.parse(localStorage.getItem('audioState') || '{"isPlaying":false,"icon":"music1.png","currentTime":0}');

        // ================= 工具函数 =================
        // 从URL参数获取当前页面（?page=tang/qing/minguo），默认tang
        function getCurrentPage() {
            const params = new URLSearchParams(window.location.search);
            const page = params.get('page');
            return page && ['tang', 'qing', 'minguo'].includes(page) ? page : 'tang';
        }

        // 跳转到下一页（通过URL参数切换）
        function goToNextPage() {
            if (isTransitioning || !currentFlow.next) return;
            isTransitioning = true;
            
            // 跳转前保存最新音频状态
            saveAudioState();
            
            // 拼接下一页URL（保持当前文件路径，只修改参数）
            const nextUrl = `${window.location.pathname}?page=${currentFlow.next}`;
            window.location.href = nextUrl;
        }

        // 新增：startBtn点击跳转函数（保存音频状态后跳转）
        function jumpToIndex5() {
            // 保存音频状态
            saveAudioState();
            window.location.href = startBtnJumpUrl;
        }

        // 新增：保存音频状态到localStorage
        function saveAudioState() {
            audioState.currentTime = audio.currentTime;
            audioState.isPlaying = !audio.paused;
            audioState.icon = document.getElementById('music-icon').src;
            localStorage.setItem('audioState', JSON.stringify(audioState));
        }

        // 新增：显示光圈并添加动画 - 核心功能
        function showLightRing() {
            const img2 = document.getElementById('img2');
            const lightRing = document.getElementById('lightRing');
            // 获取img2的位置和尺寸，定位光圈在其上方居中
            const img2Rect = img2.getBoundingClientRect();
            const containerRect = document.querySelector('.scene-container').getBoundingClientRect();
            // 计算相对容器的位置（避免页面滚动影响）
            const top = img2Rect.top - containerRect.top + (img2Rect.height - lightRing.offsetHeight) / 2 + 'px';
            const left = img2Rect.left - containerRect.left + (img2Rect.width - lightRing.offsetWidth) / 2 + 'px';
            // 设置光圈位置
            lightRing.style.top = top;
            lightRing.style.left = left;
            // 显示光圈并添加动画
            lightRing.style.opacity = '1';
            lightRing.classList.add('scale-pulse');
        }

        // ================= 音乐图标功能 =================
        // 初始化音乐图标点击切换功能
        function initMusicIcon() {
            const musicIcon = document.getElementById('music-icon');
            if (!musicIcon) return;

            // 页面加载时恢复音频状态
            audio.currentTime = audioState.currentTime;
            musicIcon.src = audioState.icon.includes('music1.png') ? 'music1.png' : 'music.png';
            
            // 自动续播（处理浏览器自动播放限制）
            if (audioState.isPlaying) {
                setTimeout(() => {
                    audio.play().catch(err => {
                        console.log('需点击图标恢复播放');
                    });
                }, 100);
            }

            // 点击切换图片+控制音频
            musicIcon.addEventListener('click', function(e) {
                // 阻止事件冒泡，避免触发其他交互（如朝代图标点击、页面跳转等）
                e.stopPropagation();
                
                if (audio.paused) {
                    // 暂停 → 播放
                    audio.play();
                    this.src = 'music.png';
                    audioState.isPlaying = true;
                } else {
                    // 播放 → 暂停
                    audio.pause();
                    this.src = 'music1.png';
                    audioState.isPlaying = false;
                }
                
                // 保存最新状态
                saveAudioState();
            });

            // 移动端触摸支持
            musicIcon.addEventListener('touchstart', function(e) {
                e.preventDefault();
                this.click();
            }, { passive: false });
        }

        // ================= 页面初始化 =================
        function initPage() {
            // 1. 初始化音乐图标（优先执行，确保音频状态恢复）
            initMusicIcon();

            // 2. 设置页面标题
            document.getElementById('pageTitle').textContent = currentFlow.title;

            // 3. 加载图片资源
            loadImages();

            // 4. 初始化初始动画
            initInitialAnimation();

            // 5. 绑定图标点击事件
            bindIconClick();

            // 6. 绑定跳转/交互事件
            if (currentPage === 'minguo') {
                document.querySelector('.scroll-hint').style.display = 'block';
                // 新增：绑定startBtn点击事件
                bindStartBtnClick();
            } else {
                bindJumpEvents(); // 唐朝/清朝绑定跳转事件
            }
        }

        // 加载图片资源并设置显示状态
        function loadImages() {
            const bgImg = document.getElementById('backgroundImg');
            const img1 = document.getElementById('img1');
            const img2 = document.getElementById('img2');
            const img3 = document.getElementById('img3');
            const img4CenterImage = document.getElementById('img4_centerImage');
            const img4CenterText = document.getElementById('img4_centerText');

            // 基础图片
            bgImg.src = currentConfig.background;
            img2.src = currentConfig.img2;
            img2.style.left = currentConfig.img2Left;
            img3.src = currentConfig.img3;

            // 人物图（仅唐朝显示）
            if (currentPage === 'tang' && currentConfig.img1) {
                img1.src = currentConfig.img1;
                img1.style.display = 'block';
                img1.style.right = '0px'; // 人物从右侧滑入
            } else {
                img1.style.display = 'none';
            }

            // 弹窗图片2（唐朝用center-image，清朝/民国用center-text）
            if (currentPage === 'tang') {
                img4CenterImage.src = currentConfig.img4;
                img4CenterImage.style.display = 'block';
                img4CenterText.style.display = 'none';
            } else {
                img4CenterImage.style.display = 'none';
                img4CenterText.src = currentConfig.img4;
                img4CenterText.style.display = 'block';
                img4CenterText.style.top = currentConfig.centerTextTop;
                img4CenterText.style.left = currentConfig.centerTextLeft;
            }

            // 民国特有图片
            if (currentPage === 'minguo') {
                const fog = document.getElementById('fog');
                const hualing = document.getElementById('hualing');
                const textBox = document.getElementById('textBox');
                const textContent = document.getElementById('textContent');
                const startBtn = document.getElementById('startBtn');

                fog.src = currentConfig.fog;
                hualing.src = currentConfig.hualing;
                textBox.src = currentConfig.textBox;
                textContent.src = currentConfig.textContent;
                startBtn.src = currentConfig.startBtn;

                fog.style.display = 'block';
                hualing.style.display = 'block';
                textBox.style.display = 'block';
                textContent.style.display = 'block';
                startBtn.style.display = 'block';
            }

            // 新增：img2加载完成后显示光圈
            img2.onload = function() {
                // 延迟一点，确保img2的动画完成后显示光圈（可选，根据需求调整）
                setTimeout(showLightRing, 1000); // 与img2的transition时长一致
            };
            // 兼容图片缓存的情况（图片已加载时onload不触发）
            if (img2.complete) {
                setTimeout(showLightRing, 1500);
            }
        }

        // 初始动画（图标/人物入场）
        function initInitialAnimation() {
            const img2 = document.getElementById('img2');
            img2.style.top = currentConfig.img2Top; // 图标从顶部滑入

            if (currentPage === 'tang') {
                const img1 = document.getElementById('img1');
                img1.style.right = '0px'; // 人物从右侧滑入
            }
        }

        // 图标点击事件（显示弹窗 + 标记已点击，允许后续滚动跳转）
        function bindIconClick() {
            const img2 = document.getElementById('img2');
            img2.addEventListener('click', () => {
                // 标记：已点击朝代图标，允许后续滚动跳转
                hasClickedIcon = true;
                // 显示弹窗1
                document.getElementById('img3').style.opacity = '1';

                // 延迟显示弹窗2
                setTimeout(() => {
                    if (currentPage === 'tang') {
                        document.getElementById('img4_centerImage').style.opacity = '1';
                    } else {
                        document.getElementById('img4_centerText').style.opacity = '1';
                    }

                    // 民国页面：点击后启用滚动检测
                    if (currentPage === 'minguo') {
                        enableScrollDetection();
                    }
                }, 500);
            });

            // 移动端触摸支持
            img2.addEventListener('touchstart', (e) => {
                e.preventDefault();
                img2.click();
            });
        }

        // 新增：绑定startBtn点击事件
        function bindStartBtnClick() {
            const startBtn = document.getElementById('startBtn');
            // 点击事件
            startBtn.addEventListener('click', jumpToIndex5);
            // 移动端触摸支持
            startBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                jumpToIndex5();
            }, { passive: false });
        }

        // ================= 跳转事件绑定（唐朝/清朝） =================
        function bindJumpEvents() {
            const container = document.querySelector('.scene-container');

            // 1. 移动端上滑（任意上滑都触发，需先点击图标）
            let startY = 0;
            container.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
            }, { passive: true });

            container.addEventListener('touchend', (e) => {
                // 新增：判断是否已点击图标，未点击则不触发跳转
                if (!hasClickedIcon) return;
                const endY = e.changedTouches[0].clientY;
                if (startY > endY && !isTransitioning) {
                    goToNextPage();
                }
            }, { passive: true });

            // 2. PC端滚轮（向上滚触发，需先点击图标）
            window.addEventListener('wheel', (e) => {
                // 新增：判断是否已点击图标，未点击则不触发跳转
                if (!hasClickedIcon) return;
                if (e.deltaY < 0 && !isTransitioning) {
                    goToNextPage();
                }
            }, { passive: false });

            // 3. 点击空白处触发（需先点击图标）
            container.addEventListener('click', (e) => {
                // 新增：判断是否已点击图标，未点击则不触发跳转
                if (!hasClickedIcon) return;
                if (e.target === container && !isTransitioning) {
                    goToNextPage();
                }
            });

            // 4. 键盘任意键触发（需先点击图标）
            document.addEventListener('keydown', () => {
                // 新增：判断是否已点击图标，未点击则不触发跳转
                if (!hasClickedIcon) return;
                if (!isTransitioning) {
                    goToNextPage();
                }
            });
        }

        // ================= 民国页面特有功能 =================
        function enableScrollDetection() {
            scrollDetectionEnabled = true;

            // 绑定多种触发方式
            window.addEventListener('scroll', triggerNextScene);
            window.addEventListener('wheel', triggerNextScene);
            document.addEventListener('touchmove', triggerNextScene);
            document.addEventListener('click', triggerNextScene);
        }

        function triggerNextScene() {
            if (hasTriggeredNextScene) return;
            hasTriggeredNextScene = true;

            // 隐藏提示
            document.querySelector('.scroll-hint').style.display = 'none';

            // 按顺序显示民国元素
            document.getElementById('fog').style.opacity = '1';
            setTimeout(() => document.getElementById('hualing').style.opacity = '1', 800);
            setTimeout(() => document.getElementById('textBox').style.opacity = '1', 1500);
            setTimeout(() => document.getElementById('textContent').style.opacity = '1', 2000);
            setTimeout(() => {
                const startBtn = document.getElementById('startBtn');
                startBtn.style.opacity = '1';
                startBtn.classList.add('pulse');
            }, 2500);
        }

        // ================= 启动页面 =================
        window.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>